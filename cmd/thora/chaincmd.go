// Copyright 2015 The go-ethereum Authors
// This file is part of go-ethereum.
//
// go-ethereum is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// go-ethereum is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with go-ethereum. If not, see <http://www.gnu.org/licenses/>.

package main

import (
	"encoding/json"
	"errors"
	"fmt"
	"github.com/ethereum/go-ethereum/params"
	"os"
	"runtime"
	"strconv"
	"sync/atomic"
	"time"

	"github.com/ethereum/go-ethereum/cmd/utils"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethdb"
	"github.com/ethereum/go-ethereum/internal/flags"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/metrics"
	"github.com/ethereum/go-ethereum/node"
	"github.com/ethereum/go-ethereum/trie"
	"github.com/urfave/cli/v2"
)

var (
	initCommand = &cli.Command{
		Action:    initGenesis,
		Name:      "init",
		Usage:     "Bootstrap and initialize a new genesis block",
		ArgsUsage: "<genesisPath>",
		Flags:     flags.Merge([]cli.Flag{utils.CachePreimagesFlag}, utils.DatabasePathFlags),
		Description: `
The init command initializes a new genesis block and definition for the network.
This is a destructive action and changes the network in which you will be
participating.

It expects the genesis file as argument.`,
	}
	dumpGenesisCommand = &cli.Command{
		Action:    dumpGenesis,
		Name:      "dumpgenesis",
		Usage:     "Dumps genesis block JSON configuration to stdout",
		ArgsUsage: "",
		Flags:     append([]cli.Flag{utils.DataDirFlag}, utils.NetworkFlags...),
		Description: `
The dumpgenesis command prints the genesis configuration of the network preset
if one is set.  Otherwise it prints the genesis from the datadir.`,
	}
	importCommand = &cli.Command{
		Action:    importChain,
		Name:      "import",
		Usage:     "Import a blockchain file",
		ArgsUsage: "<filename> (<filename 2> ... <filename N>) ",
		Flags: flags.Merge([]cli.Flag{
			utils.CacheFlag,
			utils.SyncModeFlag,
			utils.GCModeFlag,
			utils.SnapshotFlag,
			utils.CacheDatabaseFlag,
			utils.CacheGCFlag,
			utils.MetricsEnabledFlag,
			utils.MetricsEnabledExpensiveFlag,
			utils.MetricsHTTPFlag,
			utils.MetricsPortFlag,
			utils.MetricsEnableInfluxDBFlag,
			utils.MetricsEnableInfluxDBV2Flag,
			utils.MetricsInfluxDBEndpointFlag,
			utils.MetricsInfluxDBDatabaseFlag,
			utils.MetricsInfluxDBUsernameFlag,
			utils.MetricsInfluxDBPasswordFlag,
			utils.MetricsInfluxDBTagsFlag,
			utils.MetricsInfluxDBTokenFlag,
			utils.MetricsInfluxDBBucketFlag,
			utils.MetricsInfluxDBOrganizationFlag,
			utils.TxLookupLimitFlag,
		}, utils.DatabasePathFlags),
		Description: `
The import command imports blocks from an RLP-encoded form. The form can be one file
with several RLP-encoded blocks, or several files can be used.

If only one file is used, import error will result in failure. If several files are used,
processing will proceed even if an individual RLP-file import failure occurs.`,
	}
	exportCommand = &cli.Command{
		Action:    exportChain,
		Name:      "export",
		Usage:     "Export blockchain into file",
		ArgsUsage: "<filename> [<blockNumFirst> <blockNumLast>]",
		Flags: flags.Merge([]cli.Flag{
			utils.CacheFlag,
			utils.SyncModeFlag,
		}, utils.DatabasePathFlags),
		Description: `
Requires a first argument of the file to write to.
Optional second and third arguments control the first and
last block to write. In this mode, the file will be appended
if already existing. If the file ends with .gz, the output will
be gzipped.`,
	}
	importPreimagesCommand = &cli.Command{
		Action:    importPreimages,
		Name:      "import-preimages",
		Usage:     "Import the preimage database from an RLP stream",
		ArgsUsage: "<datafile>",
		Flags: flags.Merge([]cli.Flag{
			utils.CacheFlag,
			utils.SyncModeFlag,
		}, utils.DatabasePathFlags),
		Description: params.WaterMarkText(`
The import-preimages command imports hash preimages from an RLP encoded stream.
It's deprecated, please use "{{.GETHCmd}} db import" instead.
`),
	}
	exportPreimagesCommand = &cli.Command{
		Action:    exportPreimages,
		Name:      "export-preimages",
		Usage:     "Export the preimage database into an RLP stream",
		ArgsUsage: "<dumpfile>",
		Flags: flags.Merge([]cli.Flag{
			utils.CacheFlag,
			utils.SyncModeFlag,
		}, utils.DatabasePathFlags),
		Description: params.WaterMarkText(`
The export-preimages command exports hash preimages to an RLP encoded stream.
It's deprecated, please use "{{.GETHCmd}} db export" instead.
`),
	}
	dumpCommand = &cli.Command{
		Action:    dump,
		Name:      "dump",
		Usage:     "Dump a specific block from storage",
		ArgsUsage: "[? <blockHash> | <blockNum>]",
		Flags: flags.Merge([]cli.Flag{
			utils.CacheFlag,
			utils.IterativeOutputFlag,
			utils.ExcludeCodeFlag,
			utils.ExcludeStorageFlag,
			utils.IncludeIncompletesFlag,
			utils.StartKeyFlag,
			utils.DumpLimitFlag,
		}, utils.DatabasePathFlags),
		Description: `
This command dumps out the state for a given block (or latest, if none provided).
`,
	}
)

// initGenesis will initialise the given JSON format genesis file and writes it as
// the zero'd block (i.e. genesis) or will fail hard if it can't succeed.
func initGenesis(ctx *cli.Context) error {
	if ctx.Args().Len() != 1 {
		utils.Fatalf("need genesis.json file as the only argument")
	}
	genesisPath := ctx.Args().First()
	if len(genesisPath) == 0 {
		utils.Fatalf("invalid path to genesis file")
	}
	file, err := os.Open(genesisPath)
	if err != nil {
		utils.Fatalf("Failed to read genesis file: %v", err)
	}
	defer file.Close()

	genesis := new(core.Genesis)
	if err := json.NewDecoder(file).Decode(genesis); err != nil {
		utils.Fatalf("invalid genesis file: %v", err)
	}

	//platformTestnetAllocData := "0x7b22307830303030303030303030303030303030303030303030303030303030303030303030303030303838223a7b22636f6465223a22307836303830363034303532333438303135363130303130353736303030383066643562353036303034333631303631303137333537363030303335363065303163383036333730613038323331313136313030646535373830363361323137666464663131363130303937353738303633636131356338373331313631303037313537383036336361313563383733313436313034393835373830363364353437373431663134363130346338353738303633646436326564336531343631303465343537383036336532326362376339313436313035313435373631303137333536356238303633613231376664646631343631303431613537383036336134353763326437313436313034333835373830363361393035396362623134363130343638353736313031373335363562383036333730613038323331313436313033333235373830363337306639663435373134363130333632353738303633373963633637393031343631303338303537383036333930313064303763313436313033396335373830363339316431343835343134363130336363353738303633393564383962343131343631303366633537363130313733353635623830363332663266663135643131363130313330353738303633326632666631356431343631303237343537383036333331336365353637313436313032393035373830363333363536386162653134363130326165353738303633333935303933353131343631303263613537383036333430633130663139313436313032666135373830363334323936366336383134363130333136353736313031373335363562383036333031666663396137313436313031373835373830363330366664646530333134363130316138353738303633303935656137623331343631303163363537383036333138313630646464313436313031663635373830363332336238373264643134363130323134353738303633323438613963613331343631303234343537356236303030383066643562363130313932363030343830333630333831303139303631303138643931393036313163383535363562363130353332353635623630343035313631303139663931393036313163636435363562363034303531383039313033393066333562363130316230363130356163353635623630343035313631303162643931393036313164373835363562363034303531383039313033393066333562363130316530363030343830333630333831303139303631303164623931393036313165326535363562363130363365353635623630343035313631303165643931393036313163636435363562363034303531383039313033393066333562363130316665363130363631353635623630343035313631303230623931393036313165376435363562363034303531383039313033393066333562363130323265363030343830333630333831303139303631303232393931393036313165393835363562363130363662353635623630343035313631303233623931393036313163636435363562363034303531383039313033393066333562363130323565363030343830333630333831303139303631303235393931393036313166323135363562363130363961353635623630343035313631303236623931393036313166356435363562363034303531383039313033393066333562363130323865363030343830333630333831303139303631303238393931393036313166373835363562363130366239353635623030356236313032393836313036646135363562363034303531363130326135393139303631316664343536356236303430353138303931303339306633356236313032633836303034383033363033383130313930363130326333393139303631316637383536356236313036663135363562303035623631303265343630303438303336303338313031393036313032646639313930363131653265353635623631303737343536356236303430353136313032663139313930363131636364353635623630343035313830393130333930663335623631303331343630303438303336303338313031393036313033306639313930363131653265353635623631303761623536356230303562363130333330363030343830333630333831303139303631303332623931393036313166656635363562363130383434353635623030356236313033346336303034383033363033383130313930363130333437393139303631323031633536356236313038353835363562363034303531363130333539393139303631316537643536356236303430353138303931303339306633356236313033366136313038613135363562363034303531363130333737393139303631316635643536356236303430353138303931303339306633356236313033396136303034383033363033383130313930363130333935393139303631316532653536356236313038633535363562303035623631303362363630303438303336303338313031393036313033623139313930363132303439353635623631303865353536356236303430353136313033633339313930363132303938353635623630343035313830393130333930663335623631303365363630303438303336303338313031393036313033653139313930363131663738353635623631303931343536356236303430353136313033663339313930363131636364353635623630343035313830393130333930663335623631303430343631303937653536356236303430353136313034313139313930363131643738353635623630343035313830393130333930663335623631303432323631306131303536356236303430353136313034326639313930363131663564353635623630343035313830393130333930663335623631303435323630303438303336303338313031393036313034346439313930363131653265353635623631306131373536356236303430353136313034356639313930363131636364353635623630343035313830393130333930663335623631303438323630303438303336303338313031393036313034376439313930363131653265353635623631306138653536356236303430353136313034386639313930363131636364353635623630343035313830393130333930663335623631303462323630303438303336303338313031393036313034616439313930363131663231353635623631306162313536356236303430353136313034626639313930363131653764353635623630343035313830393130333930663335623631303465323630303438303336303338313031393036313034646439313930363131663738353635623631306164353536356230303562363130346665363030343830333630333831303139303631303466393931393036313230623335363562363130616636353635623630343035313631303530623931393036313165376435363562363034303531383039313033393066333562363130353163363130623764353635623630343035313631303532393931393036313166356435363562363034303531383039313033393066333562363030303766356130353138306630303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303762666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666631393136383237626666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666313931363134383036313035613535373530363130356134383236313063623135363562356239303530393139303530353635623630363036303035383035343631303562623930363132313232353635623830363031663031363032303830393130343032363032303031363034303531393038313031363034303532383039323931393038313831353236303230303138323830353436313035653739303631323132323536356238303135363130363334353738303630316631303631303630393537363130313030383038333534303430323833353239313630323030313931363130363334353635623832303139313930363030303532363032303630303032303930356238313534383135323930363030313031393036303230303138303833313136313036313735373832393030333630316631363832303139313562353035303530353035303930353039303536356236303030383036313036343936313064326235363562393035303631303635363831383538353631306433333536356236303031393135303530393239313530353035363562363030303630303435343930353039303536356236303030383036313036373636313064326235363562393035303631303638333835383238353631306566633536356236313036386538353835383536313066383835363562363030313931353035303933393235303530353035363562363030303830363030303833383135323630323030313930383135323630323030313630303032303630303130313534393035303931393035303536356236313036633238323631303639613536356236313036636238313631313230313536356236313036643538333833363131323135353635623530353035303536356236303030363030373630303039303534393036313031303030613930303436306666313639303530393035363562363130366639363130643262353635623733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383137336666666666666666666666666666666666666666666666666666666666666666666666666666666631363134363130373636353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363130373564393036313231633535363562363034303531383039313033393066643562363130373730383238323631313234393536356235303530353635623630303038303631303737663631306432623536356239303530363130376130383138353835363130373931383538393631306166363536356236313037396239313930363132323134353635623631306433333536356236303031393135303530393239313530353035363562363130376266363030303830316236313037626136313064326235363562363130393134353635623830363130376637353735303631303766363766623439656136346361393336336565323435353766616233626564323431343030353162323762313530613636353864643934333638353936363662323830353631303766313631306432623536356236313039313435363562356236313038333635373630343035313766303863333739613030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303831353236303034303136313038326439303631323239343536356236303430353138303931303339306664356236313038343038323832363131323764353635623530353035363562363130383535363130383466363130643262353635623832363131336434353635623530353635623630303036303032363030303833373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323035343930353039313930353035363562376662343965613634636139333633656532343535376661623362656432343134303035316232376231353061363635386464393433363835393636366232383035383135363562363130386437383236313038643136313064326235363562383336313065666335363562363130386531383238323631313364343536356235303530353635623630303036313039306338323630303136303030383638313532363032303031393038313532363032303031363030303230363131356133393039313930363366666666666666663136353635623930353039323931353035303536356236303030383036303030383438313532363032303031393038313532363032303031363030303230363030303031363030303833373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323036303030393035343930363130313030306139303034363066663136393035303932393135303530353635623630363036303036383035343631303938643930363132313232353635623830363031663031363032303830393130343032363032303031363034303531393038313031363034303532383039323931393038313831353236303230303138323830353436313039623939303631323132323536356238303135363130613036353738303630316631303631303964623537363130313030383038333534303430323833353239313630323030313931363130613036353635623832303139313930363030303532363032303630303032303930356238313534383135323930363030313031393036303230303138303833313136313039653935373832393030333630316631363832303139313562353035303530353035303930353039303536356236303030383031623831353635623630303038303631306132323631306432623536356239303530363030303631306133303832383636313061663635363562393035303833383131303135363130613735353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363130613663393036313233323635363562363034303531383039313033393066643562363130613832383238363836383430333631306433333536356236303031393235303530353039323931353035303536356236303030383036313061393936313064326235363562393035303631306161363831383538353631306638383536356236303031393135303530393239313530353035363562363030303631306163653630303136303030383438313532363032303031393038313532363032303031363030303230363131356264353635623930353039313930353035363562363130616465383236313036396135363562363130616537383136313132303135363562363130616631383338333631313234393536356235303530353035363562363030303630303336303030383437336666666666666666666666666666666666666666666666666666666666666666666666666666666631363733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383135323630323030313930383135323630323030313630303032303630303038333733666666666666666666666666666666666666666666666666666666666666666666666666666666663136373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638313532363032303031393038313532363032303031363030303230353439303530393239313530353035363562376631623239343439373132313137613534613261393663343965383036386230663838346534636530326238363130323865663534663233653930656364636432383135363562363130626162383238323631303931343536356236313063376435373630303136303030383038343831353236303230303139303831353236303230303136303030323036303030303136303030383337336666666666666666666666666666666666666666666666666666666666666666666666666666666631363733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383135323630323030313930383135323630323030313630303032303630303036313031303030613831353438313630666630323139313639303833313531353032313739303535353036313063323236313064326235363562373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638313733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383337663266383738383131376537656666316438326539323665633739343930316431376337383032346135303237303934303330343534306137333336353666306436303430353136303430353138303931303339306134356235303530353635623630303036313063613938333630303030313833373366666666666666666666666666666666666666666666666666666666666666666666666666666666313636303030316236313135643235363562393035303932393135303530353635623630303037663739363564623062303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303037626666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666313931363832376266666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666663139313631343830363130643234353735303631306432333832363131363432353635623562393035303931393035303536356236303030333339303530393035363562363030303733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383337336666666666666666666666666666666666666666666666666666666666666666666666666666666631363033363130646132353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363130643939393036313233623835363562363034303531383039313033393066643562363030303733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383237336666666666666666666666666666666666666666666666666666666666666666666666666666666631363033363130653131353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363130653038393036313234346135363562363034303531383039313033393066643562383036303033363030303835373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323036303030383437336666666666666666666666666666666666666666666666666666666666666666666666666666666631363733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383135323630323030313930383135323630323030313630303032303831393035353530383137336666666666666666666666666666666666666666666666666666666666666666666666666666666631363833373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637663863356265316535656265633764356264313466373134323764316538346633646430333134633066376232323931653562323030616338633763336239323538333630343035313631306565663931393036313165376435363562363034303531383039313033393061333530353035303536356236303030363130663038383438343631306166363536356239303530376666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666383131343631306638323537383138313130313536313066373435373630343035313766303863333739613030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303831353236303034303136313066366239303631323462363536356236303430353138303931303339306664356236313066383138343834383438343033363130643333353635623562353035303530353035363562363030303733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383337336666666666666666666666666666666666666666666666666666666666666666666666666666666631363033363130666637353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363130666565393036313235343835363562363034303531383039313033393066643562363030303733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383237336666666666666666666666666666666666666666666666666666666666666666666666666666666631363033363131303636353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363131303564393036313235646135363562363034303531383039313033393066643562363131303731383338333833363131366163353635623630303036303032363030303835373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323035343930353038313831313031353631313066383537363034303531376630386333373961303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030383135323630303430313631313065663930363132363663353635623630343035313830393130333930666435623831383130333630303236303030383637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383135323630323030313930383135323630323030313630303032303831393035353530383136303032363030303835373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323036303030383238323534303139323530353038313930353535303832373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638343733666666666666666666666666666666666666666666666666666666666666666666666666666666663136376664646632353261643162653263383962363963326230363866633337386461613935326261376631363363346131313632386635356134646635323362336566383436303430353136313131653839313930363131653764353635623630343035313830393130333930613336313131666238343834383436313136623135363562353035303530353035363562363131323132383136313132306436313064326235363562363131366236353635623530353635623631313231663832383236313062613135363562363131323434383136303031363030303835383135323630323030313930383135323630323030313630303032303631306338313930393139303633666666666666666631363536356235303530353035363562363131323533383238323631313733623536356236313132373838313630303136303030383538313532363032303031393038313532363032303031363030303230363131383163393039313930363366666666666666663136353635623530353035303536356236303030373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638323733666666666666666666666666666666666666666666666666666666666666666666666666666666663136303336313132656335373630343035313766303863333739613030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303831353236303034303136313132653339303631323664383536356236303430353138303931303339306664356236313132663836303030383338333631313661633536356238303630303436303030383238323534363131333061393139303631323231343536356239323530353038313930353535303830363030323630303038343733666666666666666666666666666666666666666666666666666666666666666666666666666666663136373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638313532363032303031393038313532363032303031363030303230363030303832383235343031393235303530383139303535353038313733666666666666666666666666666666666666666666666666666666666666666666666666666666663136363030303733666666666666666666666666666666666666666666666666666666666666666666666666666666663136376664646632353261643162653263383962363963326230363866633337386461613935326261376631363363346131313632386635356134646635323362336566383336303430353136313133626339313930363131653764353635623630343035313830393130333930613336313133643036303030383338333631313662313536356235303530353635623630303037336666666666666666666666666666666666666666666666666666666666666666666666666666666631363832373366666666666666666666666666666666666666666666666666666666666666666666666666666666313630333631313434333537363034303531376630386333373961303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030383135323630303430313631313433613930363132373661353635623630343035313830393130333930666435623631313434663832363030303833363131366163353635623630303036303032363030303834373366666666666666666666666666666666666666666666666666666666666666666666666666666666313637336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831353236303230303139303831353236303230303136303030323035343930353038313831313031353631313464363537363034303531376630386333373961303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030383135323630303430313631313463643930363132376663353635623630343035313830393130333930666435623831383130333630303236303030383537336666666666666666666666666666666666666666666666666666666666666666666666666666666631363733666666666666666666666666666666666666666666666666666666666666666666666666666666663136383135323630323030313930383135323630323030313630303032303831393035353530383136303034363030303832383235343033393235303530383139303535353036303030373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638333733666666666666666666666666666666666666666666666666666666666666666666666666666666663136376664646632353261643162653263383962363963326230363866633337386461613935326261376631363363346131313632386635356134646635323362336566383436303430353136313135386139313930363131653764353635623630343035313830393130333930613336313135396538333630303038343631313662313536356235303530353035363562363030303631313562323833363030303031383336313138346335363562363030303163393035303932393135303530353635623630303036313135636238323630303030313631313837373536356239303530393139303530353635623630303036313135646538333833363131383838353635623631313633373537383236303030303138323930383036303031383135343031383038323535383039313530353036303031393030333930363030303532363032303630303032303031363030303930393139303931393039313530353538323630303030313830353439303530383336303031303136303030383438313532363032303031393038313532363032303031363030303230383139303535353036303031393035303631313633633536356236303030393035303562393239313530353035363562363030303766303166666339613730303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303762666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666631393136383237626666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666313931363134393035303931393035303536356235303530353035363562353035303530353635623631313663303832383236313039313435363562363131373337353736313136636438313631313861623536356236313136646238333630303031633630323036313138643835363562363034303531363032303031363131366563393239313930363132386630353635623630343035313630323038313833303330333831353239303630343035323630343035313766303863333739613030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303831353236303034303136313137326539313930363131643738353635623630343035313830393130333930666435623530353035363562363131373435383238323631303931343536356231353631313831383537363030303830363030303834383135323630323030313930383135323630323030313630303032303630303030313630303038333733666666666666666666666666666666666666666666666666666666666666666666666666666666663136373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638313532363032303031393038313532363032303031363030303230363030303631303130303061383135343831363066663032313931363930383331353135303231373930353535303631313762643631306432623536356237336666666666666666666666666666666666666666666666666666666666666666666666666666666631363831373366666666666666666666666666666666666666666666666666666666666666666666666666666666313638333766663633393166356333326439633639643261343765613637306234343239373462353339333564316564633766643634656232316530343761383339313731623630343035313630343035313830393130333930613435623530353035363562363030303631313834343833363030303031383337336666666666666666666666666666666666666666666666666666666666666666666666666666666631363630303031623631316231343536356239303530393239313530353035363562363030303832363030303031383238313534383131303631313836343537363131383633363132393261353635623562393036303030353236303230363030303230303135343930353039323931353035303536356236303030383136303030303138303534393035303930353039313930353035363562363030303830383336303031303136303030383438313532363032303031393038313532363032303031363030303230353431343135393035303932393135303530353635623630363036313138643138323733666666666666666666666666666666666666666666666666666666666666666666666666666666663136363031343630666631363631313864383536356239303530393139303530353635623630363036303030363030323833363030323631313865623931393036313239353935363562363131386635393139303631323231343536356236376666666666666666666666666666666638313131313536313139306535373631313930643631323939623536356235623630343035313930383038323532383036303166303136303166313931363630323030313832303136303430353238303135363131393430353738313630323030313630303138323032383033363833333738303832303139313530353039303530356235303930353037663330303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313630303038313531383131303631313937383537363131393737363132393261353635623562363032303031303139303765666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666631393136393038313630303031613930353335303766373830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303831363030313831353138313130363131396463353736313139646236313239326135363562356236303230303130313930376566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666663139313639303831363030303161393035333530363030303630303138343630303236313161316339313930363132393539353635623631316132363931393036313232313435363562393035303562363030313831313131353631316163363537376633303331333233333334333533363337333833393631363236333634363536363030303030303030303030303030303030303030303030303030303030303030363030663836313636303130383131303631316136383537363131613637363132393261353635623562316136306638316238323832383135313831313036313161376635373631316137653631323932613536356235623630323030313031393037656666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666313931363930383136303030316139303533353036303034383539303163393435303830363131616266393036313239636135363562393035303631316132393536356235303630303038343134363131623061353736303430353137663038633337396130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038313532363030343031363131623031393036313261336635363562363034303531383039313033393066643562383039313530353039323931353035303536356236303030383038333630303130313630303038343831353236303230303139303831353236303230303136303030323035343930353036303030383131343631316331633537363030303630303138323631316234363931393036313261356635363562393035303630303036303031383636303030303138303534393035303631316235653931393036313261356635363562393035303831383131343631316263643537363030303836363030303031383238313534383131303631316237663537363131623765363132393261353635623562393036303030353236303230363030303230303135343930353038303837363030303031383438313534383131303631316261333537363131626132363132393261353635623562393036303030353236303230363030303230303138313930353535303833383736303031303136303030383338313532363032303031393038313532363032303031363030303230383139303535353035303562383536303030303138303534383036313162653135373631316265303631326139333536356235623630303139303033383138313930363030303532363032303630303032303031363030303930353539303535383536303031303136303030383638313532363032303031393038313532363032303031363030303230363030303930353536303031393335303530353035303631316332323536356236303030393135303530356239323931353035303536356236303030383066643562363030303766666666666666666630303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303832313639303530393139303530353635623631316336323831363131633264353635623831313436313163366435373630303038306664356235303536356236303030383133353930353036313163376638313631316335393536356239323931353035303536356236303030363032303832383430333132313536313163396235373631316339613631316332383536356235623630303036313163613938343832383530313631316337303536356239313530353039323931353035303536356236303030383131353135393035303931393035303536356236313163633738313631316362323536356238323532353035303536356236303030363032303832303139303530363131636532363030303833303138343631316362653536356239323931353035303536356236303030383135313930353039313930353035363562363030303832383235323630323038323031393035303932393135303530353635623630303035623833383131303135363131643232353738303832303135313831383430313532363032303831303139303530363131643037353635623630303038343834303135323530353035303530353635623630303036303166313936303166383330313136393035303931393035303536356236303030363131643461383236313163653835363562363131643534383138353631316366333536356239333530363131643634383138353630323038363031363131643034353635623631316436643831363131643265353635623834303139313530353039323931353035303536356236303030363032303832303139303530383138313033363030303833303135323631316439323831383436313164336635363562393035303932393135303530353635623630303037336666666666666666666666666666666666666666666666666666666666666666666666666666666638323136393035303931393035303536356236303030363131646335383236313164396135363562393035303931393035303536356236313164643538313631316462613536356238313134363131646530353736303030383066643562353035363562363030303831333539303530363131646632383136313164636335363562393239313530353035363562363030303831393035303931393035303536356236313165306238313631316466383536356238313134363131653136353736303030383066643562353035363562363030303831333539303530363131653238383136313165303235363562393239313530353035363562363030303830363034303833383530333132313536313165343535373631316534343631316332383536356235623630303036313165353338353832383630313631316465333536356239323530353036303230363131653634383538323836303136313165313935363562393135303530393235303932393035303536356236313165373738313631316466383536356238323532353035303536356236303030363032303832303139303530363131653932363030303833303138343631316536653536356239323931353035303536356236303030383036303030363036303834383630333132313536313165623135373631316562303631316332383536356235623630303036313165626638363832383730313631316465333536356239333530353036303230363131656430383638323837303136313164653335363562393235303530363034303631316565313836383238373031363131653139353635623931353035303932353039323530393235363562363030303831393035303931393035303536356236313165666538313631316565623536356238313134363131663039353736303030383066643562353035363562363030303831333539303530363131663162383136313165663535363562393239313530353035363562363030303630323038323834303331323135363131663337353736313166333636313163323835363562356236303030363131663435383438323835303136313166306335363562393135303530393239313530353035363562363131663537383136313165656235363562383235323530353035363562363030303630323038323031393035303631316637323630303038333031383436313166346535363562393239313530353035363562363030303830363034303833383530333132313536313166386635373631316638653631316332383536356235623630303036313166396438353832383630313631316630633536356239323530353036303230363131666165383538323836303136313164653335363562393135303530393235303932393035303536356236303030363066663832313639303530393139303530353635623631316663653831363131666238353635623832353235303530353635623630303036303230383230313930353036313166653936303030383330313834363131666335353635623932393135303530353635623630303036303230383238343033313231353631323030353537363132303034363131633238353635623562363030303631323031333834383238353031363131653139353635623931353035303932393135303530353635623630303036303230383238343033313231353631323033323537363132303331363131633238353635623562363030303631323034303834383238353031363131646533353635623931353035303932393135303530353635623630303038303630343038333835303331323135363132303630353736313230356636313163323835363562356236303030363132303665383538323836303136313166306335363562393235303530363032303631323037663835383238363031363131653139353635623931353035303932353039323930353035363562363132303932383136313164626135363562383235323530353035363562363030303630323038323031393035303631323061643630303038333031383436313230383935363562393239313530353035363562363030303830363034303833383530333132313536313230636135373631323063393631316332383536356235623630303036313230643838353832383630313631316465333536356239323530353036303230363132306539383538323836303136313164653335363562393135303530393235303932393035303536356237663465343837623731303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303030353236303232363030343532363032343630303066643562363030303630303238323034393035303630303138323136383036313231336135373630376638323136393135303562363032303832313038313033363132313464353736313231346336313230663335363562356235303931393035303536356237663431363336333635373337333433366636653734373236663663336132303633363136653230366636653663373932303732363536653666373536653633363536303030383230313532376632303732366636633635373332303636366637323230373336353663363630303030303030303030303030303030303030303030303030303030303030303030363032303832303135323530353635623630303036313231616636303266383336313163663335363562393135303631323162613832363132313533353635623630343038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323164653831363132316132353635623930353039313930353035363562376634653438376237313030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030363030303532363031313630303435323630323436303030666435623630303036313232316638323631316466383536356239313530363132323261383336313164663835363562393235303832383230313930353038303832313131353631323234323537363132323431363132316535353635623562393239313530353035363562376634343666366537343230363836313736363532303464363936653734363537323230373036353732366436393733373336393666366532313030303030303030363030303832303135323530353635623630303036313232376536303163383336313163663335363562393135303631323238393832363132323438353635623630323038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323261643831363132323731353635623930353039313930353035363562376634353532343333323330336132303634363536333732363536313733363536343230363136633663366637373631366536333635323036323635366336663737363030303832303135323766323037613635373236663030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303630323038323031353235303536356236303030363132333130363032353833363131636633353635623931353036313233316238323631323262343536356236303430383230313930353039313930353035363562363030303630323038323031393035303831383130333630303038333031353236313233336638313631323330333536356239303530393139303530353635623766343535323433333233303361323036313730373037323666373636353230363637323666366432303734363836353230376136353732366632303631363436343630303038323031353237663732363537333733303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303230383230313532353035363562363030303631323361323630323438333631316366333536356239313530363132336164383236313233343635363562363034303832303139303530393139303530353635623630303036303230383230313930353038313831303336303030383330313532363132336431383136313233393535363562393035303931393035303536356237663435353234333332333033613230363137303730373236663736363532303734366632303734363836353230376136353732366632303631363436343732363536303030383230313532376637333733303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030363032303832303135323530353635623630303036313234333436303232383336313163663335363562393135303631323433663832363132336438353635623630343038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323436333831363132343237353635623930353039313930353035363562376634353532343333323330336132303639366537333735363636363639363336393635366537343230363136633663366637373631366536333635303030303030363030303832303135323530353635623630303036313234613036303164383336313163663335363562393135303631323461623832363132343661353635623630323038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323463663831363132343933353635623930353039313930353035363562376634353532343333323330336132303734373236313665373336363635373232303636373236663664323037343638363532303761363537323666323036313634363030303832303135323766363437323635373337333030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303630323038323031353235303536356236303030363132353332363032353833363131636633353635623931353036313235336438323631323464363536356236303430383230313930353039313930353035363562363030303630323038323031393035303831383130333630303038333031353236313235363138313631323532353536356239303530393139303530353635623766343535323433333233303361323037343732363136653733363636353732323037343666323037343638363532303761363537323666323036313634363437323630303038323031353237663635373337333030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303230383230313532353035363562363030303631323563343630323338333631316366333536356239313530363132356366383236313235363835363562363034303832303139303530393139303530353635623630303036303230383230313930353038313831303336303030383330313532363132356633383136313235623735363562393035303931393035303536356237663435353234333332333033613230373437323631366537333636363537323230363136643666373536653734323036353738363336353635363437333230363236303030383230313532376636313663363136653633363530303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030363032303832303135323530353635623630303036313236353636303236383336313163663335363562393135303631323636313832363132356661353635623630343038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323638353831363132363439353635623930353039313930353035363562376634353532343333323330336132303664363936653734323037343666323037343638363532303761363537323666323036313634363437323635373337333030363030303832303135323530353635623630303036313236633236303166383336313163663335363562393135303631323663643832363132363863353635623630323038323031393035303931393035303536356236303030363032303832303139303530383138313033363030303833303135323631323666313831363132366235353635623930353039313930353035363562376634353532343333323330336132303632373537323665323036363732366636643230373436383635323037613635373236663230363136343634373236353733363030303832303135323766373330303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303630323038323031353235303536356236303030363132373534363032313833363131636633353635623931353036313237356638323631323666383536356236303430383230313930353039313930353035363562363030303630323038323031393035303831383130333630303038333031353236313237383338313631323734373536356239303530393139303530353635623766343535323433333233303361323036323735373236653230363136643666373536653734323036353738363336353635363437333230363236313663363136653630303038323031353237663633363530303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303230383230313532353035363562363030303631323765363630323238333631316366333536356239313530363132376631383236313237386135363562363034303832303139303530393139303530353635623630303036303230383230313930353038313831303336303030383330313532363132383135383136313237643935363562393035303931393035303536356236303030383139303530393239313530353035363562376634313633363336353733373334333666366537343732366636633361323036313633363336663735366537343230303030303030303030303030303030303030363030303832303135323530353635623630303036313238356436303137383336313238316335363562393135303631323836383832363132383237353635623630313738323031393035303931393035303536356236303030363132383765383236313163653835363562363132383838383138353631323831633536356239333530363132383938383138353630323038363031363131643034353635623830383430313931353035303932393135303530353635623766323036393733323036643639373337333639366536373230373236663663363532303030303030303030303030303030303030303030303030303030303030303630303038323031353235303536356236303030363132386461363031313833363132383163353635623931353036313238653538323631323861343536356236303131383230313930353039313930353035363562363030303631323866623832363132383530353635623931353036313239303738323835363132383733353635623931353036313239313238323631323863643536356239313530363132393165383238343631323837333536356239313530383139303530393339323530353035303536356237663465343837623731303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303030353236303332363030343532363032343630303066643562363030303631323936343832363131646638353635623931353036313239366638333631316466383536356239323530383238323032363132393764383136313164663835363562393135303832383230343834313438333135313736313239393435373631323939333631323165353536356235623530393239313530353035363562376634653438376237313030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030363030303532363034313630303435323630323436303030666435623630303036313239643538323631316466383536356239313530363030303832303336313239653835373631323965373631323165353536356235623630303138323033393035303931393035303536356237663533373437323639366536373733336132303638363537383230366336353665363737343638323036393665373337353636363636393633363936353665373436303030383230313532353035363562363030303631326132393630323038333631316366333536356239313530363132613334383236313239663335363562363032303832303139303530393139303530353635623630303036303230383230313930353038313831303336303030383330313532363132613538383136313261316335363562393035303931393035303536356236303030363132613661383236313164663835363562393135303631326137353833363131646638353635623932353038323832303339303530383138313131313536313261386435373631326138633631323165353536356235623932393135303530353635623766346534383762373130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303630303035323630333136303034353236303234363030306664666561323634363937303636373335383232313232303563343332616139363439353635313536636638326131323134356536323664383439626339323366666462613334306466623837623037313665343865333536343733366636633633343330303038313230303333222c2273746f72616765223a7b22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303433227d2c2262616c616e6365223a22307830227d2c22307865643139643963653733393261376632323632613637383137653064626166363864663034326238223a7b2262616c616e6365223a223078323034666365356533303434346261643638396330303030227d7d"
	//genesisAlloc := contractintgr.DecodePreAlloc(platformTestnetAllocData)
	//genesis := &core.Genesis{
	//	Config:     params.PlatformTestnetChainConfig,
	//	Timestamp:  1583482152,
	//	Nonce:      0,
	//	ExtraData:  hexutil.MustDecode("0x0000000000000000000000000000000000000000000000000000000000000000f202ae205bBF80148a8c615670eBEF9ec63191f90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
	//	GasLimit:   30000000,
	//	Difficulty: big.NewInt(1),
	//	Alloc:      genesisAlloc,
	//}

	// Open and initialise both full and light databases
	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	for _, name := range []string{"chaindata", "lightchaindata"} {
		chaindb, err := stack.OpenDatabaseWithFreezer(name, 0, 0, ctx.String(utils.AncientFlag.Name), "", false)
		if err != nil {
			utils.Fatalf("Failed to open database: %v", err)
		}
		triedb := trie.NewDatabaseWithConfig(chaindb, &trie.Config{
			Preimages: ctx.Bool(utils.CachePreimagesFlag.Name),
		})
		_, hash, err := core.SetupGenesisBlock(chaindb, triedb, genesis)
		if err != nil {
			utils.Fatalf("Failed to write genesis block: %v", err)
		}
		chaindb.Close()
		log.Info("Successfully wrote genesis state", "database", name, "hash", hash)
		fmt.Printf("Genesis hash %v\n", hash)
	}
	return nil
}

func dumpGenesis(ctx *cli.Context) error {
	// if there is a testnet preset enabled, dump that
	if utils.IsNetworkPreset(ctx) {
		genesis := utils.MakeGenesis(ctx)
		if err := json.NewEncoder(os.Stdout).Encode(genesis); err != nil {
			utils.Fatalf("could not encode genesis: %s", err)
		}
		return nil
	}
	// dump whatever already exists in the datadir
	stack, _ := makeConfigNode(ctx)
	for _, name := range []string{"chaindata", "lightchaindata"} {
		db, err := stack.OpenDatabase(name, 0, 0, "", true)
		if err != nil {
			if !os.IsNotExist(err) {
				return err
			}
			continue
		}
		genesis, err := core.ReadGenesis(db)
		if err != nil {
			utils.Fatalf("failed to read genesis: %s", err)
		}
		db.Close()

		if err := json.NewEncoder(os.Stdout).Encode(*genesis); err != nil {
			utils.Fatalf("could not encode stored genesis: %s", err)
		}
		return nil
	}
	if ctx.IsSet(utils.DataDirFlag.Name) {
		utils.Fatalf("no existing datadir at %s", stack.Config().DataDir)
	}
	utils.Fatalf("no network preset provided.  no exisiting genesis in the default datadir")
	return nil
}

func importChain(ctx *cli.Context) error {
	if ctx.Args().Len() < 1 {
		utils.Fatalf("This command requires an argument.")
	}
	// Start metrics export if enabled
	utils.SetupMetrics(ctx)
	// Start system runtime metrics collection
	go metrics.CollectProcessMetrics(3 * time.Second)

	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	chain, db := utils.MakeChain(ctx, stack, false)
	defer db.Close()

	// Start periodically gathering memory profiles
	var peakMemAlloc, peakMemSys uint64
	go func() {
		stats := new(runtime.MemStats)
		for {
			runtime.ReadMemStats(stats)
			if atomic.LoadUint64(&peakMemAlloc) < stats.Alloc {
				atomic.StoreUint64(&peakMemAlloc, stats.Alloc)
			}
			if atomic.LoadUint64(&peakMemSys) < stats.Sys {
				atomic.StoreUint64(&peakMemSys, stats.Sys)
			}
			time.Sleep(5 * time.Second)
		}
	}()
	// Import the chain
	start := time.Now()

	var importErr error

	if ctx.Args().Len() == 1 {
		if err := utils.ImportChain(chain, ctx.Args().First()); err != nil {
			importErr = err
			log.Error("Import error", "err", err)
		}
	} else {
		for _, arg := range ctx.Args().Slice() {
			if err := utils.ImportChain(chain, arg); err != nil {
				importErr = err
				log.Error("Import error", "file", arg, "err", err)
			}
		}
	}
	chain.Stop()
	fmt.Printf("Import done in %v.\n\n", time.Since(start))

	// Output pre-compaction stats mostly to see the import trashing
	showLeveldbStats(db)

	// Print the memory statistics used by the importing
	mem := new(runtime.MemStats)
	runtime.ReadMemStats(mem)

	fmt.Printf("Object memory: %.3f MB current, %.3f MB peak\n", float64(mem.Alloc)/1024/1024, float64(atomic.LoadUint64(&peakMemAlloc))/1024/1024)
	fmt.Printf("System memory: %.3f MB current, %.3f MB peak\n", float64(mem.Sys)/1024/1024, float64(atomic.LoadUint64(&peakMemSys))/1024/1024)
	fmt.Printf("Allocations:   %.3f million\n", float64(mem.Mallocs)/1000000)
	fmt.Printf("GC pause:      %v\n\n", time.Duration(mem.PauseTotalNs))

	if ctx.Bool(utils.NoCompactionFlag.Name) {
		return nil
	}

	// Compact the entire database to more accurately measure disk io and print the stats
	start = time.Now()
	fmt.Println("Compacting entire database...")
	if err := db.Compact(nil, nil); err != nil {
		utils.Fatalf("Compaction failed: %v", err)
	}
	fmt.Printf("Compaction done in %v.\n\n", time.Since(start))

	showLeveldbStats(db)
	return importErr
}

func exportChain(ctx *cli.Context) error {
	if ctx.Args().Len() < 1 {
		utils.Fatalf("This command requires an argument.")
	}

	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	chain, _ := utils.MakeChain(ctx, stack, true)
	start := time.Now()

	var err error
	fp := ctx.Args().First()
	if ctx.Args().Len() < 3 {
		err = utils.ExportChain(chain, fp)
	} else {
		// This can be improved to allow for numbers larger than 9223372036854775807
		first, ferr := strconv.ParseInt(ctx.Args().Get(1), 10, 64)
		last, lerr := strconv.ParseInt(ctx.Args().Get(2), 10, 64)
		if ferr != nil || lerr != nil {
			utils.Fatalf("Export error in parsing parameters: block number not an integer\n")
		}
		if first < 0 || last < 0 {
			utils.Fatalf("Export error: block number must be greater than 0\n")
		}
		if head := chain.CurrentSnapBlock(); uint64(last) > head.Number.Uint64() {
			utils.Fatalf("Export error: block number %d larger than head block %d\n", uint64(last), head.Number.Uint64())
		}
		err = utils.ExportAppendChain(chain, fp, uint64(first), uint64(last))
	}

	if err != nil {
		utils.Fatalf("Export error: %v\n", err)
	}
	fmt.Printf("Export done in %v\n", time.Since(start))
	return nil
}

// importPreimages imports preimage data from the specified file.
func importPreimages(ctx *cli.Context) error {
	if ctx.Args().Len() < 1 {
		utils.Fatalf("This command requires an argument.")
	}

	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	db := utils.MakeChainDatabase(ctx, stack, false)
	start := time.Now()

	if err := utils.ImportPreimages(db, ctx.Args().First()); err != nil {
		utils.Fatalf("Import error: %v\n", err)
	}
	fmt.Printf("Import done in %v\n", time.Since(start))
	return nil
}

// exportPreimages dumps the preimage data to specified json file in streaming way.
func exportPreimages(ctx *cli.Context) error {
	if ctx.Args().Len() < 1 {
		utils.Fatalf("This command requires an argument.")
	}
	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	db := utils.MakeChainDatabase(ctx, stack, true)
	start := time.Now()

	if err := utils.ExportPreimages(db, ctx.Args().First()); err != nil {
		utils.Fatalf("Export error: %v\n", err)
	}
	fmt.Printf("Export done in %v\n", time.Since(start))
	return nil
}

func parseDumpConfig(ctx *cli.Context, stack *node.Node) (*state.DumpConfig, ethdb.Database, common.Hash, error) {
	db := utils.MakeChainDatabase(ctx, stack, true)
	var header *types.Header
	if ctx.NArg() > 1 {
		return nil, nil, common.Hash{}, fmt.Errorf("expected 1 argument (number or hash), got %d", ctx.NArg())
	}
	if ctx.NArg() == 1 {
		arg := ctx.Args().First()
		if hashish(arg) {
			hash := common.HexToHash(arg)
			if number := rawdb.ReadHeaderNumber(db, hash); number != nil {
				header = rawdb.ReadHeader(db, hash, *number)
			} else {
				return nil, nil, common.Hash{}, fmt.Errorf("block %x not found", hash)
			}
		} else {
			number, err := strconv.ParseUint(arg, 10, 64)
			if err != nil {
				return nil, nil, common.Hash{}, err
			}
			if hash := rawdb.ReadCanonicalHash(db, number); hash != (common.Hash{}) {
				header = rawdb.ReadHeader(db, hash, number)
			} else {
				return nil, nil, common.Hash{}, fmt.Errorf("header for block %d not found", number)
			}
		}
	} else {
		// Use latest
		header = rawdb.ReadHeadHeader(db)
	}
	if header == nil {
		return nil, nil, common.Hash{}, errors.New("no head block found")
	}
	startArg := common.FromHex(ctx.String(utils.StartKeyFlag.Name))
	var start common.Hash
	switch len(startArg) {
	case 0: // common.Hash
	case 32:
		start = common.BytesToHash(startArg)
	case 20:
		start = crypto.Keccak256Hash(startArg)
		log.Info("Converting start-address to hash", "address", common.BytesToAddress(startArg), "hash", start.Hex())
	default:
		return nil, nil, common.Hash{}, fmt.Errorf("invalid start argument: %x. 20 or 32 hex-encoded bytes required", startArg)
	}
	var conf = &state.DumpConfig{
		SkipCode:          ctx.Bool(utils.ExcludeCodeFlag.Name),
		SkipStorage:       ctx.Bool(utils.ExcludeStorageFlag.Name),
		OnlyWithAddresses: !ctx.Bool(utils.IncludeIncompletesFlag.Name),
		Start:             start.Bytes(),
		Max:               ctx.Uint64(utils.DumpLimitFlag.Name),
	}
	log.Info("State dump configured", "block", header.Number, "hash", header.Hash().Hex(),
		"skipcode", conf.SkipCode, "skipstorage", conf.SkipStorage,
		"start", hexutil.Encode(conf.Start), "limit", conf.Max)
	return conf, db, header.Root, nil
}

func dump(ctx *cli.Context) error {
	stack, _ := makeConfigNode(ctx)
	defer stack.Close()

	conf, db, root, err := parseDumpConfig(ctx, stack)
	if err != nil {
		return err
	}
	config := &trie.Config{
		Preimages: true, // always enable preimage lookup
	}
	state, err := state.New(root, state.NewDatabaseWithConfig(db, config), nil)
	if err != nil {
		return err
	}
	if ctx.Bool(utils.IterativeOutputFlag.Name) {
		state.IterativeDump(conf, json.NewEncoder(os.Stdout))
	} else {
		if conf.OnlyWithAddresses {
			fmt.Fprintf(os.Stderr, "If you want to include accounts with missing preimages, you need iterative output, since"+
				" otherwise the accounts will overwrite each other in the resulting mapping.")
			return errors.New("incompatible options")
		}
		fmt.Println(string(state.Dump(conf)))
	}
	return nil
}

// hashish returns true for strings that look like hashes.
func hashish(x string) bool {
	_, err := strconv.Atoi(x)
	return err != nil
}
